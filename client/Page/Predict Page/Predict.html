<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Medical Analyst Predict</title>
    <link rel="stylesheet" href="Predict.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="../Home Page/logo.png" type="image/x-icon">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo-container">
            <img src="../Home Page/logo.png" alt="Logo" class="logo">
            <h1>Medical Analytics System</h1>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <a href="../Home Page/Home.html" class="back-icon" onclick="clearUploadedImage()"><i class="fa-solid fa-arrow-left"></i></a>
        <!-- Sidebar with Predict Button and Images -->
        <div class="sidebar">
            <button class="predict-btn">PREDICT</button>
            <div class="image-wrapper">
                <div class="image-preview">
                    <img id="uploaded-image-preview" src="input-placeholder.png" alt="Ảnh input ban đầu">
                </div>
                <div class="image-preview">
                    <img src="output-placeholder.png" alt="Ảnh sau khi Predict">
                </div>
            </div>
        </div>

        <!-- Main Image Display Area -->
        <div class="image-display">
            <div class="large-image-box">
                <img id="uploaded-large-image" src="input-placeholder.png" alt="Ảnh để predict">
            </div>
            <div class="controls">

                <button class="control-icon"><i class="fa-solid fa-circle-half-stroke"></i></button>
                <button class="control-icon"><i class="fa-solid fa-rotate"></i></button>
                <button class="control-icon"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
                <button class="control-icon"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
            </div>
        </div>

        <!-- Result and Download Section -->
        <div class="result-section">
            <div class="result-box">
                <h3>Result</h3>
                <p>Kết quả dự đoán</p>
            </div>
            <button class="download-btn" onclick="downloadImage()">DOWNLOAD</button>
        </div>
    </div>
</body>
<footer>
    <p>Copyright NhatNam_LanAnh © 2024</p>
</footer>
<script>
    function clearUploadedImage() {
        localStorage.removeItem("uploadedImage");
    }
    // Khi trang Predict tải, kiểm tra xem có ảnh nào trong localStorage không
    window.onload = function() {
        const uploadedImage = localStorage.getItem("uploadedImage");
        if (uploadedImage) {
            // Hiển thị ảnh lên cả hai vị trí
            document.getElementById("uploaded-image-preview").src = uploadedImage;
            document.getElementById("uploaded-large-image").src = uploadedImage;
        }
    };
    window.onload = function() {
    const uploadedImage = localStorage.getItem("uploadedImage");
    if (uploadedImage) {
        // Hiển thị ảnh đã xử lý ở cả hai vị trí trong trang predict.html
        document.getElementById("uploaded-image-preview").src = uploadedImage;
        document.getElementById("uploaded-large-image").src = uploadedImage;
    }
};


    async function predictImage() {
        const uploadedImage = localStorage.getItem("uploadedImage");
        if (!uploadedImage) {
            alert("Vui lòng tải ảnh lên trước.");
            return;
        }
        try {
            // Send the image to the backend API
            const response = await fetch("http://127.0.0.1:9999/api/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image: uploadedImage })
            }); 

            if (!response.ok) {
                throw new Error(`API request failed with status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.processed_image) {
                // Display the processed image in both frames
                const processedImageSrc = `data:image/png;base64,${result.processed_image}`;
                document.getElementById("uploaded-large-image").src = processedImageSrc;
                document.getElementById("uploaded-image-preview").src = processedImageSrc;
                localStorage.setItem("uploadedImage", processedImageSrc);
            } else {
                console.error("Lỗi khi xử lý ảnh:", result.error || "Unknown error occurred.");
                alert("Có lỗi xảy ra khi xử lý ảnh. Vui lòng thử lại.");
            }
        } catch (error) {
            console.error("Lỗi khi gọi API:", error.message);
            alert("Không thể kết nối đến API. Vui lòng kiểm tra lại kết nối.");
        }
    }

    // Gán hàm predictImage vào các nút Predict
    document.querySelector('.predict-btn').addEventListener('click', predictImage);
    function downloadImage() {
    const largeImage = document.getElementById("uploaded-large-image");
    const imageURL = largeImage.src;

    // Kiểm tra nếu ảnh đã được thay đổi từ ảnh placeholder
    if (imageURL.includes("input-placeholder.png") || imageURL.includes("output-placeholder.png")) {
        alert("Vui lòng chọn ảnh trước khi tải xuống.");
        return;
    }

    // Tạo một thẻ liên kết ẩn để tải ảnh
    const downloadLink = document.createElement("a");
    downloadLink.href = imageURL;
    downloadLink.download = "predicted-image.png";  // Tên file khi tải về
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

</script>
</html>
